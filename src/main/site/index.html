<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Carrot<sup>2</sup> search results clustering plugin for ElasticSearch</title>

    <link href="assets/css/bootstrap.min.css" rel="stylesheet" />
    <link href="assets/css/prettify.css" rel="stylesheet" />

    <style>
      #foamtree, #circles {
        color: #888;
        height: 400px;
      }

      span.step {
        display: inline-block;
        margin: 10px;
        padding: 10px 20px;
        border-radius: 10px;
        background-color: rgba(0,0,0,.2);
        color: white;
        font-size: 20px;
      }

      .dropped {
        margin-top: 15px;
      }
    </style>
  </head>

  <body>
    <div class="container">
      <div class="row">
        <div class="span12">
          <div class="page-header">
            <h1>elasticsearch-carrot2</h1>

            <p>A plugin for clustering search results in real time. Includes
            clustering algorithms from the
              <a href="http://project.carrot2.org">Carrot<sup>2</sup></a> project.</p>
          </div>
        </div>
      </div>

      <div class="row">
        <div class="span1"><span class="step">1</span></div>
        <div class="span11 dropped">
          <form class="form-inline" id="indexform">
            First, <button class="btn btn-primary" id="indexbtn">index sample</button>
            documents to be clustered.
          </form>
        </div>
      </div>

      <div class="row">
        <div class="span1"><span class="step">2</span></div>
        <div class="span11 dropped">
          Then, type in a query like:
          <form class="form-inline" id="searchform">
            <input id="query" type="text" style="width: 30em" value="data mining" />
            and
            <button class="btn btn-primary" id="search">Search, cluster &amp; visualize</button>
            <span id="progress"></span>
          </form>
        </div>
      </div>

      <div class="row">
        <div id="foamtree" class="span6">
          Loading Carrot Search FoamTree visualization...
        </div>
        <div id="circles" class="span6">
          Loading Carrot Search Circles visualization...
        </div>
      </div>

      <div class="row" style="margin-top: 10px;">
        <div class="span1"><span class="step">3</span></div>
        <div class="span11 dropped">
          Finally, check out <a href="examples.html">clustering query/response REST API</a> examples.
        </div>
      </div>

      <script src="assets/js/jquery-2.0.2.min.js"></script>
      <script src="assets/js/carrotsearch.circles.html5.min.js"></script>
      <script src="assets/js/carrotsearch.foamtree.html5.min.js"></script>
      <script src="assets/js/sample-data.js"></script>
      <script>
        $(document).ready(function () {
          // Initialize visualizations
          var circles = new CarrotSearchCircles({
            id: "circles",
            groupOutlineColor: "#fff",
            groupOutlineWidth: 3,
            titleBar: "inscribed",
            titleBarTextColor: "rgba(0,0,0,.5)",
            visibleGroupCount: 10,

          });
          var foamtree = new CarrotSearchFoamTree({
            id: "foamtree",
            backgroundColor: "#fff"
          });

          // Index some sample documents.
          $("#indexform").submit(function (e) {
            e.preventDefault();
            doIndex(function(current, total) {
              $("#indexbtn").text(
                      current < total ? "Indexing... " + current : "[you've indexed]"
              );
            });
          });

            // Initiate search when form is submitted
          $("#searchform").submit(function (e) {
            e.preventDefault();

            var $progress = $("#progress");
            var query = $("#query").val();

            // ES search request data
            var request = {
              "search_request": {
                "fields": [ "url", "title", "content" ],
                "query": {
                  "match": { "_all": query }
                },
                "size": 100
              },

              "query_hint": query,
              "field_mapping": {
                "title": ["fields.title", "fields.content"]
              }
            };

            $progress.text("loading...");
            $.post("/test/test/_search_with_clusters",
              JSON.stringify(request), function (result) {
                if (result.hits.total > 0) {
                  $progress.text("");
                } else {
                  $progress.text("no results found");
                }

                // Convert the results to the format required by the visualization
                var visualizationInput = {
                  groups: result.clusters.map(function mapper(cluster) {
                    return {
                      label: cluster.phrases[0],
                      weight: cluster.documents.length,
                      groups: (cluster.clusters || []).map(mapper)
                    }
                  })
                };
                foamtree.set("dataObject", visualizationInput);
                circles.set("dataObject", visualizationInput);
            })
          });
        });
      </script>
    </div>
  </body>
</html>
